// { hex: '#1C1C1C', name: 'Dark Gray' },
//     { hex: '#2E2E2E', name: 'Dim Gray' },
//     { hex: '#3F3F3F', name: 'Gray' },
//     { hex: '#4F4F4F', name: 'Dark Slate Gray' },
//     { hex: '#5F5F5F', name: 'Slate Gray' },
//     { hex: '#6F6F6F', name: 'Light Slate Gray' },
//     { hex: '#7F7F7F', name: 'Silver' },
//     { hex: '#8F8F8F', name: 'Dark Silver' },
//     { hex: '#9F9F9F', name: 'Gainsboro' },
//     { hex: '#AFAFAF', name: 'Light Gray' },
//     { hex: '#BFBFBF', name: 'Dark Gray' },
//     { hex: '#CFCFCF', name: 'Very Light Gray' },
//     { hex: '#DCDCDC', name: 'Gainsboro' },
//     { hex: '#E0E0E0', name: 'Light Gray' },
//     { hex: '#E5E5E5', name: 'Very Light Gray' },
//     { hex: '#EBEBEB', name: 'White Smoke' },
//     { hex: '#F0F0F0', name: 'White' },
//     { hex: '#FFFFFF', name: 'White' },
//     { hex: '#FF0000', name: 'Red' },
//     { hex: '#8B0000', name: 'Dark Red' },
//     { hex: '#A52A2A', name: 'Brown' },
//     { hex: '#B22222', name: 'Firebrick' },
//     { hex: '#DC143C', name: 'Crimson' },
//     { hex: '#FF4500', name: 'Orange Red' },
//     { hex: '#FF6347', name: 'Tomato' },
//     { hex: '#FF7F50', name: 'Coral' },
//     { hex: '#CD5C5C', name: 'Indian Red' },
//     { hex: '#F08080', name: 'Light Coral' },
//     { hex: '#E9967A', name: 'Dark Salmon' },
//     { hex: '#FA8072', name: 'Salmon' },
//     { hex: '#FFA07A', name: 'Light Salmon' },
//     { hex: '#FF8C00', name: 'Dark Orange' },
//     { hex: '#FFA500', name: 'Orange' },
//     { hex: '#FFD700', name: 'Gold' },
//     { hex: '#FFFF00', name: 'Yellow' },
//     { hex: '#FFFFE0', name: 'Light Yellow' },
//     { hex: '#FFFACD', name: 'Lemon Chiffon' },
//     { hex: '#FAFAD2', name: 'Light Goldenrod Yellow' },
//     { hex: '#FFEFD5', name: 'Papaya Whip' },
//     { hex: '#FFE4B5', name: 'Moccasin' },
//     { hex: '#FFDAB9', name: 'Peach Puff' },
//     { hex: '#EEE8AA', name: 'Pale Goldenrod' },
//     { hex: '#F0E68C', name: 'Khaki' },
//     { hex: '#BDB76B', name: 'Dark Khaki' },
//     { hex: '#ADFF2F', name: 'Green Yellow' },
//     { hex: '#7FFF00', name: 'Chartreuse' },
//     { hex: '#7CFC00', name: 'Lawn Green' },
//     { hex: '#00FF00', name: 'Green' },
//     { hex: '#32CD32', name: 'Lime Green' },
//     { hex: '#98FB98', name: 'Pale Green' },
//     { hex: '#00FA9A', name: 'Medium Spring Green' },
//     { hex: '#00FF7F', name: 'Spring Green' },
//     { hex: '#2E8B57', name: 'Sea Green' },
//     { hex: '#228B22', name: 'Forest Green' },
//     { hex: '#008000', name: 'Dark Green' },
//     { hex: '#006400', name: 'Dark Olive Green' },
//     { hex: '#556B2F', name: 'Olive Drab' },
//     { hex: '#6B8E23', name: 'Olive' },
//     { hex: '#808000', name: 'Dark Olive' },
//     { hex: '#9ACD32', name: 'Yellow Green' },
//     { hex: '#32CD32', name: 'Lime Green' },
//     { hex: '#00FF00', name: 'Lime' },
//     { hex: '#7FFF00', name: 'Chartreuse' },
//     { hex: '#7CFC00', name: 'Lawn Green' },
//     { hex: '#ADFF2F', name: 'Green Yellow' },
//     { hex: '#00FF7F', name: 'Spring Green' },
//     { hex: '#00FA9A', name: 'Medium Spring Green' },
//     { hex: '#90EE90', name: 'Light Green' },
//     { hex: '#98FB98', name: 'Pale Green' },
//     { hex: '#8FBC8F', name: 'Dark Sea Green' },
//     { hex: '#3CB371', name: 'Medium Sea Green' },
//     { hex: '#2E8B57', name: 'Sea Green' },
//     { hex: '#228B22', name: 'Forest Green' },
//     { hex: '#008000', name: 'Green' },
//     { hex: '#006400', name: 'Dark Green' },
//     { hex: '#66CDAA', name: 'Medium Aquamarine' },
//     { hex: '#8A2BE2', name: 'Blue Violet' },
//     { hex: '#5F9EA0', name: 'Cadet Blue' },
//     { hex: '#D2691E', name: 'Chocolate' },
//     { hex: '#6495ED', name: 'Cornflower Blue' },
//     { hex: '#FFF8DC', name: 'Cornsilk' },
//     { hex: '#00FFFF', name: 'Cyan' },
//     { hex: '#00008B', name: 'Dark Blue' },
//     { hex: '#008B8B', name: 'Dark Cyan' },
//     { hex: '#B8860B', name: 'Dark Goldenrod' },
//     { hex: '#A9A9A9', name: 'Dark Gray' },
//     { hex: '#8B008B', name: 'Dark Magenta' },
//     { hex: '#556B2F', name: 'Dark Olive Green' },
//     { hex: '#FF8C00', name: 'Dark Orange' },
//     { hex: '#9932CC', name: 'Dark Orchid' },
//     { hex: '#8B0000', name: 'Dark Red' },
//     { hex: '#E9967A', name: 'Dark Salmon' },
//     { hex: '#8FBC8F', name: 'Dark Sea Green' },
//     { hex: '#483D8B', name: 'Dark Slate Blue' },
//     { hex: '#2F4F4F', name: 'Dark Slate Gray' },
//     { hex: '#00CED1', name: 'Dark Turquoise' },
//     { hex: '#9400D3', name: 'Dark Violet' },
//     { hex: '#FF1493', name: 'Deep Pink' },
//     { hex: '#00BFFF', name: 'Deep Sky Blue' },
//     { hex: '#696969', name: 'Dim Gray' },
//     { hex: '#1E90FF', name: 'Dodger Blue' },
//     { hex: '#B22222', name: 'Firebrick' },
//     { hex: '#FFFAF0', name: 'Floral White' },
//     { hex: '#228B22', name: 'Forest Green' },
//     { hex: '#DCDCDC', name: 'Gainsboro' },
//     { hex: '#F8F8FF', name: 'Ghost White' },
//     { hex: '#FFD700', name: 'Gold' },
//     { hex: '#DAA520', name: 'Goldenrod' },
//     { hex: '#808080', name: 'Gray' },
//     { hex: '#F0FFF0', name: 'Honeydew' },
//     { hex: '#FF69B4', name: 'Hot Pink' },
//     { hex: '#CD5C5C', name: 'Indian Red' },
//     { hex: '#4B0082', name: 'Indigo' },
//     { hex: '#FFFFF0', name: 'Ivory' },
//     { hex: '#F0E68C', name: 'Khaki' },
//     { hex: '#E6E6FA', name: 'Lavender' },
//     { hex: '#FFF0F5', name: 'Lavender Blush' },
//     { hex: '#7CFC00', name: 'Lawn Green' },
//     { hex: '#FFFACD', name: 'Lemon Chiffon' },
//     { hex: '#ADD8E6', name: 'Light Blue' },
//     { hex: '#F08080', name: 'Light Coral' },
//     { hex: '#E0FFFF', name: 'Light Cyan' },
//     { hex: '#FAFAD2', name: 'Light Goldenrod Yellow' },
//     { hex: '#D3D3D3', name: 'Light Gray' },
//     { hex: '#90EE90', name: 'Light Green' },
//     { hex: '#FFB6C1', name: 'Light Pink' },
//     { hex: '#FFA07A', name: 'Light Salmon' },
//     { hex: '#20B2AA', name: 'Light Sea Green' },
//     { hex: '#87CEFA', name: 'Light Sky Blue' },
//     { hex: '#778899', name: 'Light Slate Gray' },
//     { hex: '#B0C4DE', name: 'Light Steel Blue' },
//     { hex: '#FFFFE0', name: 'Light Yellow' },
//     { hex: '#32CD32', name: 'Lime Green' },
//     { hex: '#FAF0E6', name: 'Linen' },
//     { hex: '#FF00FF', name: 'Magenta' },
//     { hex: '#800000', name: 'Maroon' },
//     { hex: '#66CDAA', name: 'Medium Aquamarine' },
//     { hex: '#0000CD', name: 'Medium Blue' },
//     { hex: '#BA55D3', name: 'Medium Orchid' },
//     { hex: '#9370DB', name: 'Medium Purple' },
//     { hex: '#3CB371', name: 'Medium Sea Green' },
//     { hex: '#7B68EE', name: 'Medium Slate Blue' },
//     { hex: '#00FA9A', name: 'Medium Spring Green' },
//     { hex: '#48D1CC', name: 'Medium Turquoise' },
//     { hex: '#C71585', name: 'Medium Violet Red' },
//     { hex: '#191970', name: 'Midnight Blue' },
//     { hex: '#F5FFFA', name: 'Mint Cream' },
//     { hex: '#FFE4E1', name: 'Misty Rose' },
//     { hex: '#FFE4B5', name: 'Moccasin' },
//     { hex: '#FFDEAD', name: 'Navajo White' },
//     { hex: '#000080', name: 'Navy' },
//     { hex: '#FDF5E6', name: 'Old Lace' },
//     { hex: '#808000', name: 'Olive' },
//     { hex: '#6B8E23', name: 'Olive Drab' },
//     { hex: '#FFA500', name: 'Orange' },
//     { hex: '#FF4500', name: 'Orange Red' },
//     { hex: '#DA70D6', name: 'Orchid' },
//     { hex: '#EEE8AA', name: 'Pale Goldenrod' },
//     { hex: '#98FB98', name: 'Pale Green' },
//     { hex: '#AFEEEE', name: 'Pale Turquoise' },
//     { hex: '#DB7093', name: 'Pale Violet Red' },
//     { hex: '#FFEFD5', name: 'Papaya Whip' },
//     { hex: '#FFDAB9', name: 'Peach Puff' },
//     { hex: '#CD853F', name: 'Peru' },
//     { hex: '#FFC0CB', name: 'Pink' },
//     { hex: '#DDA0DD', name: 'Plum' },
//     { hex: '#B0E0E6', name: 'Powder Blue' },
//     { hex: '#BC8F8F', name: 'Rosy Brown' },
//     { hex: '#4169E1', name: 'Royal Blue' },
//     { hex: '#8B4513', name: 'Saddle Brown' },
//     { hex: '#FA8072', name: 'Salmon' },
//     { hex: '#F4A460', name: 'Sandy Brown' },
//     { hex: '#2E8B57', name: 'Sea Green' },
//     { hex: '#FFF5EE', name: 'Seashell' },
//     { hex: '#A0522D', name: 'Sienna' },
//     { hex: '#C0C0C0', name: 'Silver' },
//     { hex: '#87CEEB', name: 'Sky Blue' },
//     { hex: '#6A5ACD', name: 'Slate Blue' },
//     { hex: '#708090', name: 'Slate Gray' },
//     { hex: '#FFFAFA', name: 'Snow' },
//     { hex: '#00FF7F', name: 'Spring Green' },
//     { hex: '#4682B4', name: 'Steel Blue' },
//     { hex: '#D2B48C', name: 'Tan' },
//     { hex: '#008080', name: 'Teal' },
//     { hex: '#D8BFD8', name: 'Thistle' },
//     { hex: '#FF6347', name: 'Tomato' },
//     { hex: '#40E0D0', name: 'Turquoise' },
//     { hex: '#EE82EE', name: 'Violet' },
//     { hex: '#F5DEB3', name: 'Wheat' },
//     { hex: '#FFFFFF', name: 'White' },
//     { hex: '#F5F5F5', name: 'White Smoke' },
//     { hex: '#FFFF00', name: 'Yellow' },
//     { hex: '#9ACD32', name: 'Yellow Green' }

import React, { useState, useEffect } from 'react';
import './newOrder.css';
import Header from './header';
import axios from 'axios';
import apis from '../utils/api';
import toast from 'react-hot-toast';

const NewOrder = () => {
  const [currentDateTime] = useState(new Date().toLocaleString());
  const [selectedPayment, setSelectedPayment] = useState('');
  const [took, settook] = useState('');
  const [selectedDueTime, setSelectedDueTime] = useState('');
  const [customDueTime, setCustomDueTime] = useState('');
  const [designImages, setDesignImages] = useState([]);
  const [itemImages, setItemImages] = useState([]);

  // New Design Section State
  const [designColors, setDesignColors] = useState([]);
  const [designPlacements, setDesignPlacements] = useState([]);
  const [designSize, setDesignSize] = useState('FILL');
  
  // New Text Section State
  const [textFont, setTextFont] = useState('Arial');
  const [textColors, setTextColors] = useState([]);
  const [textPlacements, setTextPlacements] = useState([]);
  const [textSize, setTextSize] = useState('FILL');

  // Modals for design and text color selection
  const [showDesignColorModal, setShowDesignColorModal] = useState(false);
  const [showTextColorModal, setShowTextColorModal] = useState(false);

  const handleItemImagesChange = (e) => {
    const files = Array.from(e.target.files).map((file) => ({
      file,
      preview: URL.createObjectURL(file),
    }));
    setItemImages((prev) => [...prev, ...files]);
  };

  const removeItemImage = (index) => {
    setItemImages((prev) => prev.filter((_, i) => i !== index));
  };

  const [customer, setCustomer] = useState({
    name: '',
    phone: '',
    email: '',
    company: '',
  });

  const [items, setItems] = useState([
    {
      id: '1',
      barcode: '',
      itemNumber: '',
      color: '',
      price: '',
      cost: '',
      quantity: '',
      selectedColors: [],
      selectedPlacements: [],
    },
  ]);

  // -- Backend helper functions --
  const createItem = async (itemData) => {
    const res = await axios.post(apis().newItem, itemData);
    return res.data.item._id;
  };

  const createDesign = async (designData) => {
    const res = await axios.post(apis().newDesign, designData);
    return res.data.design._id;
  };

  const createCustomer = async (customerData) => {
    const res = await axios.post(apis().newCustomer, customerData);
    return res.data.customer._id;
  };

  const createPayment = async (paymentData) => {
    const res = await axios.post(apis().newOrderPayment, paymentData);
    return res.data.payment._id;
  };

  const uploadImages = async (formData) => {
    try {
      const res = await axios.post(apis().images, formData, {
        headers: {
          'Content-Type': 'multipart/form-data',
        },
      });
      console.log('Full response from server:', res.data); 
      return res.data.images; 
    } catch (error) {
      console.error('Upload failed:', error);
      return [];
    }
  };

  const createFinalOrder = async (orderData) => {
    const res = await axios.post(apis().newOrder, orderData);
    return res.data.order._id;
  };

  // -- Standard Color Modal for items --
  const [showColorModal, setShowColorModal] = useState(false);
  const [itemForColorModal, setItemForColorModal] = useState(null);
  const openColorModal = (itemId) => {
    setItemForColorModal(itemId);
    setShowColorModal(true);
  };

  const closeColorModal = () => {
    setShowColorModal(false);
    setItemForColorModal(null);
  };

  const colorChart = [
    { hex: '#000000', name: 'Black' },
    { hex: '#0B0B0B', name: 'Very Dark Gray' },
  ];

  const handlePlacementClick = (itemId, placement) => {
    setItems((prevItems) =>
      prevItems.map((item) => {
        if (item.id === itemId) {
          const newPlacements = item.selectedPlacements.includes(placement)
            ? item.selectedPlacements.filter((p) => p !== placement)
            : [...item.selectedPlacements, placement];
          return { ...item, selectedPlacements: newPlacements };
        }
        return item;
      })
    );
  };

  const handleColorSelect = (itemId, hex) => {
    setItems((prevItems) =>
      prevItems.map((item) => {
        if (item.id === itemId) {
          const newColors = item.selectedColors.includes(hex)
            ? item.selectedColors.filter((c) => c !== hex)
            : [...item.selectedColors, hex];
          return { ...item, selectedColors: newColors };
        }
        return item;
      })
    );
  };

  const handleItemChange = (itemId, field, value) => {
    setItems((prevItems) =>
      prevItems.map((item) =>
        item.id === itemId ? { ...item, [field]: value } : item
      )
    );
  };

  const addItem = () => {
    const newId = (parseInt(items[items.length - 1].id) + 1).toString();
    setItems((prev) => [
      ...prev,
      {
        id: newId,
        barcode: '',
        itemNumber: '',
        color: '',
        price: '',
        cost: '',
        quantity: '',
        selectedColors: [],
        selectedPlacements: [],
      },
    ]);
  };

  const removeItem = (itemId) => {
    if (items.length > 1) {
      setItems((prev) => prev.filter((item) => item.id !== itemId));
    }
  };

  const handleDesignImagesChange = (e) => {
    const files = Array.from(e.target.files).map((file) => ({
      file,
      preview: URL.createObjectURL(file),
    }));
    setDesignImages((prev) => [...prev, ...files]);
  };

  const removeDesignImage = (index) => {
    setDesignImages((prev) => prev.filter((_, i) => i !== index));
  };

  const handleDueTimeSelect = (time) => {
    setSelectedDueTime(time);
    const now = new Date();
    let dueDate = new Date(now);
    switch (time) {
      case '15min':
        dueDate.setMinutes(now.getMinutes() + 15);
        break;
      case '20min':
        dueDate.setMinutes(now.getMinutes() + 20);
        break;
      case '30min':
        dueDate.setMinutes(now.getMinutes() + 30);
        break;
      case '1hour':
        dueDate.setHours(now.getHours() + 1);
        break;
      default:
        break;
    }
    setCustomDueTime(dueDate.toISOString().slice(0, 16));
  };

  useEffect(() => {
    let buffer = '';
    let lastKeyTime = Date.now();
    const handleKeyPress = (e) => {
      const currentTime = Date.now();
      if (currentTime - lastKeyTime > 100) {
        buffer = '';
      }
      if (e.key === 'Enter') {
        if (buffer) {
          handleItemChange(items[0].id, 'barcode', buffer);
          buffer = '';
        }
      } else {
        buffer += e.key;
      }
      lastKeyTime = currentTime;
    };
    window.addEventListener('keypress', handleKeyPress);
    return () => window.removeEventListener('keypress', handleKeyPress);
  }, [items]);

  const fetchCustomerByPhone = async (phone) => {
    const mockDB = {
      '1234567890': {
        name: 'John Doe',
        email: 'john@example.com',
        company: 'Acme Inc.',
      },
      '9876543210': {
        name: 'Jane Smith',
        email: 'jane@example.com',
        company: 'Globex Corp.',
      },
    };
    return mockDB[phone] || null;
  };

  const handlePhoneBlur = async (e) => {
    const phone = e.target.value;
    if (phone) {
      const result = await fetchCustomerByPhone(phone);
      if (result) {
        setCustomer((prev) => ({ ...prev, phone, ...result }));
      }
    }
  };

  const handleCustomerChange = (field, value) => {
    setCustomer((prev) => ({ ...prev, [field]: value }));
  };

  const calculateTotalPrice = () => {
    return items.reduce((sum, item) => {
      const price = parseFloat(item.price) || 0;
      const quantity = parseFloat(item.quantity) || 1;
      return sum + price * quantity;
    }, 0);
  };

  const handleSubmit = (e) => {
    e.preventDefault();
    setShowCheckoutModal(true);
  };

  // --- Modified Order Submission with Updated Design & Text Payload ---
  const handlePlaceOrder = async () => {
    try {
      console.log('Starting order placement...');
      // 1. Upload item images (if any)
      let itemImageUrls = [];
      if (itemImages.length > 0) {
        const formData = new FormData();
        itemImages.forEach((fileObj) => formData.append('images', fileObj.file));
        for (let [key, value] of formData.entries()) {
          console.log('FormData entry:', key, value);
        }
        console.log('Uploading item images...', formData);
        itemImageUrls = await uploadImages(formData);
        console.log('Item image URLs:', itemImageUrls);
      }
      // 2. Create each item and get IDs
      const itemIds = await Promise.all(
        items.map(async (item) => {
          const payload = {
            name: item.itemNumber,
            color: item.color,
            price: item.price,
            cost: item.cost,
            quantity: item.quantity,
          };
          if (itemImageUrls.length > 0) {
            payload.picture = itemImageUrls[0];
          }
          return await createItem(payload);
        })
      );
      console.log('item ids', itemIds);

      // 3. Upload design images (if any)
      let designImageUrls = [];
      if (designImages.length > 0) {
        const formDataDesign = new FormData();
        designImages.forEach((fileObj) =>
          formDataDesign.append('images', fileObj.file)
        );
        designImageUrls = await uploadImages(formDataDesign);
      }
      console.log('design images url', designImageUrls);

      // 4. Create design payload based on API JSON format
      const designPayload = {
        pictures: [
          {
            pictureFiles: designImageUrls,
            colorChart: designColors.map(hex => ({
              item: "T-shirt", // Adjust as needed
              color: colorChart.find(c => c.hex === hex)?.name || hex
            })),
            placement: designPlacements.map(pos => ({
              position1: pos,
              position2: '' // Adjust secondary position if needed
            })),
            size: designSize
          }
        ],
        text: [
          {
            font: textFont,
            color: textColors.map(hex => ({
              item: "Banner", // Adjust as needed
              color: colorChart.find(c => c.hex === hex)?.name || hex
            })),
            placement: textPlacements.map(pos => ({
              position1: pos,
              position2: '' // Adjust if needed
            })),
            size: textSize
          }
        ]
      };
      const designId = await createDesign(designPayload);
      console.log('design ids', designId);

      // 5. Create customer
      const customerId = await createCustomer({
        name: customer.name,
        number: customer.phone,
        email: customer.email,
        company: customer.company,
      });
      console.log('customer id', customerId);

      // 6. Create payment
      const paymentId = await createPayment({
        method: selectedPayment.toUpperCase(),
        amount: calculateTotalPrice(),
        layaway: took === 'layaway',
        quote: took === 'quote',
      });
      console.log('payment id', paymentId);

      // 7. Create final order
      const authData = JSON.parse(localStorage.getItem('authData'));
      const orderPayload = {
        items: itemIds,
        design: designId,
        customer: customerId,
        payments: [paymentId],
        createdBy: authData?.username || 'unknown',
        duedate: customDueTime,
      };
      const orderdata = await createFinalOrder(orderPayload);
      console.log('order id', orderdata);

      setShowCheckoutModal(false);
      alert('Order placed successfully!');
    } catch (error) {
      console.error('Error placing order:', error);
      alert('Error placing order');
    }
  };

  // --- Render the updated Design & Text Section ---
  const renderDesignSection = () => (
    <div className="section">
      <h2 className="section-title">Design</h2>
      {/* Design Image Upload */}
      <div className="upload-area">
        <p>Upload Design Image(s)</p>
        <input
          type="file"
          accept="image/*"
          multiple
          capture="environment"
          onChange={handleDesignImagesChange}
        />
      </div>
      {/* Design Images Preview */}
      <div className="design-images-preview">
        {designImages.map((img, index) => (
          <div key={index} className="preview-item">
            <img src={img.preview} alt={`Design Preview ${index}`} />
            <button type="button" onClick={() => removeDesignImage(index)}>
              Remove
            </button>
          </div>
        ))}
      </div>
      {/* Design Color Selection */}
      <div className="form-group">
        <label className="form-label">Design Color Selection</label>
        <button
          type="button"
          className="open-color-modal-button"
          onClick={() => setShowDesignColorModal(true)}
        >
          Select Colors
        </button>
        <div className="selected-colors">
          {designColors.map(color => (
            <div key={color} className="selected-color-pill">
              <div className="color-swatch" style={{ backgroundColor: color }} />
              {colorChart.find(c => c.hex === color)?.name}
            </div>
          ))}
        </div>
      </div>
      {/* Design Placement */}
      <div className="form-group">
        <label className="form-label">Design Placement</label>
        <div className="placement-grid">
          {[...Array(9)].map((_, i) => (
            <div
              key={`D${i + 1}`}
              className={`placement-cell ${designPlacements.includes(`D${i + 1}`) ? 'selected' : ''}`}
              onClick={() =>
                setDesignPlacements(prev =>
                  prev.includes(`D${i + 1}`)
                    ? prev.filter(p => p !== `D${i + 1}`)
                    : [...prev, `D${i + 1}`]
                )
              }
            >
              D{i + 1}
            </div>
          ))}
        </div>
      </div>
      {/* Design Size */}
      <div className="form-group">
        <label className="form-label">Design Size</label>
        <input
          type="text"
          className="form-input"
          value={designSize}
          onChange={(e) => setDesignSize(e.target.value)}
          placeholder="Enter size"
        />
      </div>
      {/* Text Properties */}
      <div className="text-section">
        <h3 className="section-title">Text Properties</h3>
        {/* Font Selection */}
        <div className="form-group">
          <label className="form-label">Font</label>
          <select
            className="form-select"
            value={textFont}
            onChange={(e) => setTextFont(e.target.value)}
          >
            <option>Arial</option>
            <option>Times New Roman</option>
            <option>Helvetica</option>
          </select>
        </div>
        {/* Text Color Selection */}
        <div className="form-group">
          <label className="form-label">Text Color</label>
          <button
            type="button"
            className="open-color-modal-button"
            onClick={() => setShowTextColorModal(true)}
          >
            Select Colors
          </button>
          <div className="selected-colors">
            {textColors.map(color => (
              <div key={color} className="selected-color-pill">
                <div className="color-swatch" style={{ backgroundColor: color }} />
                {colorChart.find(c => c.hex === color)?.name}
              </div>
            ))}
          </div>
        </div>
        {/* Text Placement */}
        <div className="form-group">
          <label className="form-label">Text Placement</label>
          <div className="placement-grid">
            {[...Array(9)].map((_, i) => (
              <div
                key={`T${i + 1}`}
                className={`placement-cell ${textPlacements.includes(`T${i + 1}`) ? 'selected' : ''}`}
                onClick={() =>
                  setTextPlacements(prev =>
                    prev.includes(`T${i + 1}`)
                      ? prev.filter(p => p !== `T${i + 1}`)
                      : [...prev, `T${i + 1}`]
                  )
                }
              >
                T{i + 1}
              </div>
            ))}
          </div>
        </div>
        {/* Text Size */}
        <div className="form-group">
          <label className="form-label">Text Size</label>
          <input
            type="text"
            className="form-input"
            value={textSize}
            onChange={(e) => setTextSize(e.target.value)}
            placeholder="Enter size"
          />
        </div>
      </div>
    </div>
  );

  return (
    <>
      <Header />
      <div className="new-order-container">
        <form onSubmit={handleSubmit}>
          <div className="global-controls">
            <button type="button" className="add-item-button" onClick={addItem}>
              Add New Item
            </button>
          </div>
          <div className="section">
            <h2 className="section-title">Date/Time</h2>
            <div className="form-group">
              <input type="text" className="form-input" value={currentDateTime} readOnly />
            </div>
          </div>
          {items.map((item, index) => (
            <div key={item.id}>
              <div className="section">
                <div className="item-number">Item #{index + 1}</div>
                {items.length > 1 && (
                  <button type="button" className="remove-button" onClick={() => removeItem(item.id)}>
                    Remove
                  </button>
                )}
                <h2 className="section-title">Item</h2>
                <div className="form-group">
                  <label className="form-label">POS Scan</label>
                  <div className="scanner-container">
                    <input
                      type="text"
                      className="form-input scanner-input"
                      value={item.barcode}
                      onChange={(e) => handleItemChange(item.id, 'barcode', e.target.value)}
                      placeholder="Scan barcode or enter manually"
                    />
                    <svg className="scanner-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                      <path
                        strokeLinecap="round"
                        strokeLinejoin="round"
                        strokeWidth={2}
                        d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z"
                      />
                    </svg>
                  </div>
                </div>
                <div className="form-group">
                  <h3 className="section-title">New Item</h3>
                  <div className="grid-container">
                    <input
                      type="text"
                      className="form-input"
                      placeholder="Item Number"
                      value={item.itemNumber}
                      onChange={(e) => handleItemChange(item.id, 'itemNumber', e.target.value)}
                    />
                    <input
                      type="text"
                      className="form-input"
                      placeholder="Color"
                      value={item.color}
                      onChange={(e) => handleItemChange(item.id, 'color', e.target.value)}
                    />
                    <input
                      type="number"
                      className="form-input"
                      placeholder="Price"
                      value={item.price}
                      onChange={(e) => handleItemChange(item.id, 'price', e.target.value)}
                    />
                    <input
                      type="number"
                      className="form-input"
                      placeholder="Cost"
                      value={item.cost}
                      onChange={(e) => handleItemChange(item.id, 'cost', e.target.value)}
                    />
                    <input
                      type="number"
                      className="form-input"
                      placeholder="Quantity"
                      value={item.quantity}
                      onChange={(e) => handleItemChange(item.id, 'quantity', e.target.value)}
                    />
                  </div>
                  <div className="upload-area">
                    <p>Upload Item Image(s)</p>
                    <input
                      type="file"
                      accept="image/*"
                      multiple
                      capture="environment"
                      onChange={handleItemImagesChange}
                    />
                  </div>
                  <div className="design-images-preview">
                    {itemImages.map((img, index) => (
                      <div key={index} className="preview-item">
                        <img src={img.preview} alt={`Item Image Preview ${index}`} />
                        <button type="button" onClick={() => removeItemImage(index)}>
                          Remove
                        </button>
                      </div>
                    ))}
                  </div>
                </div>
              </div>
              <div className="form-group">
                <label className="form-label">Color Selection</label>
                <button type="button" className="open-color-modal-button" onClick={() => openColorModal(item.id)}>
                  Select Colors
                </button>
                {item.selectedColors.length > 0 && (
                  <div className="selected-colors">
                    {item.selectedColors.map((color) => (
                      <div key={color} className="selected-color-pill">
                        <div className="selected-color-swatch" style={{ backgroundColor: color }} />
                        {colorChart.find((c) => c.hex === color)?.name}
                      </div>
                    ))}
                  </div>
                )}
              </div>
              <div className="form-group">
                <label className="form-label">Placement</label>
                <div className="placement-grid">
                  {[...Array(9)].map((_, i) => (
                    <div
                      key={`A${i + 1}`}
                      className={`placement-cell ${item.selectedPlacements.includes(`A${i + 1}`) ? 'selected' : ''}`}
                      onClick={() => handlePlacementClick(item.id, `A${i + 1}`)}
                    >
                      A{i + 1}
                    </div>
                  ))}
                  {[...Array(9)].map((_, i) => (
                    <div
                      key={`H${i + 1}`}
                      className={`placement-cell ${item.selectedPlacements.includes(`H${i + 1}`) ? 'selected' : ''}`}
                      onClick={() => handlePlacementClick(item.id, `H${i + 1}`)}
                    >
                      H{i + 1}
                    </div>
                  ))}
                </div>
              </div>
              <hr />
            </div>
          ))}
          
          {/* Render the new Design & Text Section */}
          {renderDesignSection()}
          
          <div className="section">
            <h2 className="section-title">Due</h2>
            <div className="time-buttons">
              <button
                type="button"
                className={`time-button ${selectedDueTime === '15min' ? 'selected' : ''}`}
                onClick={() => handleDueTimeSelect('15min')}
              >
                15 min
              </button>
              <button
                type="button"
                className={`time-button ${selectedDueTime === '20min' ? 'selected' : ''}`}
                onClick={() => handleDueTimeSelect('20min')}
              >
                20 min
              </button>
              <button
                type="button"
                className={`time-button ${selectedDueTime === '30min' ? 'selected' : ''}`}
                onClick={() => handleDueTimeSelect('30min')}
              >
                30 min
              </button>
              <button
                type="button"
                className={`time-button ${selectedDueTime === '1hour' ? 'selected' : ''}`}
                onClick={() => handleDueTimeSelect('1hour')}
              >
                1 hour
              </button>
              <input
                type="datetime-local"
                className="form-input"
                value={customDueTime}
                onChange={(e) => {
                  setCustomDueTime(e.target.value);
                  setSelectedDueTime('custom');
                }}
              />
            </div>
          </div>
          
          <div className="section">
            <h2 className="section-title">Customer Information</h2>
            <div className="grid-container">
              <input
                type="text"
                className="form-input"
                placeholder="Name"
                value={customer.name}
                onChange={(e) => handleCustomerChange('name', e.target.value)}
              />
              <input
                type="tel"
                className="form-input"
                placeholder="Phone Number"
                value={customer.phone}
                onChange={(e) => handleCustomerChange('phone', e.target.value)}
                onBlur={handlePhoneBlur}
              />
              <input
                type="email"
                className="form-input"
                placeholder="Email Address"
                value={customer.email}
                onChange={(e) => handleCustomerChange('email', e.target.value)}
              />
              <input
                type="text"
                className="form-input"
                placeholder="Company"
                value={customer.company}
                onChange={(e) => handleCustomerChange('company', e.target.value)}
              />
            </div>
          </div>
          
          <div className="section">
            <h2 className="section-title">Payment</h2>
            <div className="payment-options">
              <div
                className={`payment-option ${selectedPayment === 'cash' ? 'selected' : ''}`}
                onClick={() => setSelectedPayment('cash')}
              >
                Cash
              </div>
              <div
                className={`payment-option ${selectedPayment === 'card' ? 'selected' : ''}`}
                onClick={() => setSelectedPayment('card')}
              >
                Card
              </div>
              <div
                className={`payment-option ${selectedPayment === 'check' ? 'selected' : ''}`}
                onClick={() => setSelectedPayment('check')}
              >
                Check
              </div>
              <div
                className={`payment-option ${took === 'layaway' ? 'selected' : ''}`}
                onClick={() => settook('layaway')}
              >
                Layaway (50%)
              </div>
              <div
                className={`payment-option ${took === 'quote' ? 'selected' : ''}`}
                onClick={() => settook('quote')}
              >
                Quote
              </div>
            </div>
          </div>
          
          <button type="submit" className="submit-button">
            Review Order
          </button>
        </form>
      </div>

      {/* Standard Color Modal for Items */}
      {showColorModal && (
        <div className="color-modal">
          <div className="color-modal-content">
            <button type="button" className="close-button" onClick={closeColorModal}>
              X
            </button>
            <div className="color-chart">
              {colorChart.map((color) => (
                <div
                  key={color.hex}
                  className={`color-swatch ${
                    items.find((i) => i.id === itemForColorModal)?.selectedColors.includes(color.hex)
                      ? 'selected'
                      : ''
                  }`}
                  style={{ backgroundColor: color.hex }}
                  onClick={() => handleColorSelect(itemForColorModal, color.hex)}
                  title={color.name}
                />
              ))}
            </div>
          </div>
        </div>
      )}

      {/* Design Color Modal */}
      {showDesignColorModal && (
        <div className="color-modal">
          <div className="color-modal-content">
            <button type="button" className="close-button" onClick={() => setShowDesignColorModal(false)}>
              X
            </button>
            <div className="color-chart">
              {colorChart.map((color) => (
                <div
                  key={color.hex}
                  className={`color-swatch ${designColors.includes(color.hex) ? 'selected' : ''}`}
                  style={{ backgroundColor: color.hex }}
                  onClick={() => setDesignColors(prev =>
                    prev.includes(color.hex) ? prev.filter(c => c !== color.hex) : [...prev, color.hex]
                  )}
                  title={color.name}
                />
              ))}
            </div>
          </div>
        </div>
      )}

      {/* Text Color Modal */}
      {showTextColorModal && (
        <div className="color-modal">
          <div className="color-modal-content">
            <button type="button" className="close-button" onClick={() => setShowTextColorModal(false)}>
              X
            </button>
            <div className="color-chart">
              {colorChart.map((color) => (
                <div
                  key={color.hex}
                  className={`color-swatch ${textColors.includes(color.hex) ? 'selected' : ''}`}
                  style={{ backgroundColor: color.hex }}
                  onClick={() => setTextColors(prev =>
                    prev.includes(color.hex) ? prev.filter(c => c !== color.hex) : [...prev, color.hex]
                  )}
                  title={color.name}
                />
              ))}
            </div>
          </div>
        </div>
      )}

      {showCheckoutModal && (
        <div className="checkout-modal">
          <div className="checkout-modal-content">
            <button type="button" className="close-button" onClick={() => setShowCheckoutModal(false)}>
              X
            </button>
            <h2>Checkout</h2>
            <div className="checkout-items">
              {items.map((item) => {
                const price = parseFloat(item.price) || 0;
                const quantity = parseFloat(item.quantity) || 1;
                const amount = (price * quantity).toFixed(2);
                return (
                  <div key={item.id} className="checkout-item">
                    <p>
                      {item.itemNumber || `Item ${item.id}`}: ${amount}
                    </p>
                  </div>
                );
              })}
            </div>
            <p className="total-price">
              Total Price: ${calculateTotalPrice().toFixed(2)}
            </p>
            <button
              type="button"
              className="place-order-button"
              onClick={handlePlaceOrder}
            >
              Place Order
            </button>
          </div>
        </div>
      )}
    </>
  );
};

export default NewOrder;